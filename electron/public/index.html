<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‘½ä»¤ç®¡ç†å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #f5f7fa;
            color: #333;
            height: 100vh;
            overflow: hidden;
        }
        
        .app {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 280px;
            background: #fff;
            border-right: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .search-box {
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 10px 12px 10px 40px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }

        .search-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
        }

        .categories {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .category-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-bottom: 4px;
        }

        .category-item:hover {
            background: #f3f4f6;
        }

        .category-item.active {
            background: #eff6ff;
            color: #2563eb;
        }

        .category-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .category-count {
            margin-left: auto;
            background: #f3f4f6;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            color: #6b7280;
        }
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            padding: 20px 24px;
            border-bottom: 1px solid #e5e7eb;
            background: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            font-size: 24px;
            font-weight: 600;
            color: #111827;
        }

        .add-button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .add-button:hover {
            background: #2563eb;
        }

        .commands-container {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
            background: #f9fafb;
        }

        .command-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .command-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .command-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .command-name {
            font-size: 18px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 4px;
        }

        .command-category {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #6b7280;
        }

        .command-actions {
            display: flex;
            gap: 8px;
        }

        .action-button {
            padding: 6px 12px;
            border: 1px solid #d1d5db;
            background: white;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-button:hover {
            background: #f3f4f6;
        }

        .action-button.primary {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .action-button.primary:hover {
            background: #2563eb;
        }

        .action-button.favorite {
            background: #fef2f2;
            border-color: #fecaca;
            color: #dc2626;
        }

        .action-button.favorite:hover {
            background: #fee2e2;
        }

        .command-code {
            background: #f3f4f6;
            padding: 12px;
            border-radius: 8px;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 14px;
            color: #374151;
            margin: 12px 0;
            word-break: break-all;
        }

        .command-description {
            color: #6b7280;
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 12px;
        }

        .command-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #9ca3af;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }

        .close-button {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #9ca3af;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #374151;
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
        }

        .button {
            padding: 10px 20px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .button.secondary {
            background: white;
            color: #374151;
        }

        .button.secondary:hover {
            background: #f3f4f6;
        }

        .button.primary {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .button.primary:hover {
            background: #2563eb;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            z-index: 1001;
            transform: translateX(100%);
            transition: transform 0.3s;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            border-left: 4px solid #10b981;
        }

        .toast.error {
            border-left: 4px solid #ef4444;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .color-option {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .color-option:hover {
            transform: scale(1.1);
        }

        .color-option.selected {
            border-color: #374151;
            transform: scale(1.1);
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- ä¾§è¾¹æ  -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon">âš¡</div>
                    <div>
                        <div style="font-weight: 600; font-size: 16px;">å‘½ä»¤ç®¡ç†</div>
                        <div style="font-size: 12px; color: #6b7280;">å¿«é€Ÿå‘½ä»¤å·¥å…·</div>
                    </div>
                </div>

                <div class="search-box">
                    <input type="text" class="search-input" placeholder="æœç´¢å‘½ä»¤..." id="searchInput">
                    <div class="search-icon">ğŸ”</div>
                </div>
            </div>

            <div class="categories" id="categoriesList">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>

            <!-- ç»Ÿè®¡é¢æ¿ -->
            <div style="padding: 20px; border-top: 1px solid #e5e7eb; background: #f9fafb;">
                <div style="font-size: 12px; color: #6b7280; margin-bottom: 8px;">ğŸ“Š ç»Ÿè®¡ä¿¡æ¯</div>
                <div id="statsPanel" style="font-size: 11px; color: #9ca3af; line-height: 1.4;">
                    <div>æ€»å‘½ä»¤: <span id="totalCommands">0</span></div>
                    <div>æ”¶è—: <span id="favoriteCommands">0</span></div>
                    <div>ä»Šæ—¥ä½¿ç”¨: <span id="todayUsage">0</span></div>
                </div>
            </div>

            <!-- ä½¿ç”¨æŒ‡å—æŒ‰é’® -->
            <div style="padding: 16px 20px; border-top: 1px solid #e5e7eb; background: #f9fafb;">
                <button onclick="showHelpModal()" style="
                    width: 100%;
                    padding: 10px;
                    background: #f3f4f6;
                    border: 1px solid #d1d5db;
                    border-radius: 8px;
                    color: #374151;
                    font-size: 12px;
                    cursor: pointer;
                    transition: all 0.2s;
                ">
                    ğŸ“– ä½¿ç”¨æŒ‡å—
                </button>
            </div>
        </div>

        <!-- ä¸»å†…å®¹åŒº -->
        <div class="main-content">
            <div class="header">
                <h1 class="header-title">å‘½ä»¤åˆ—è¡¨</h1>
                <div style="display: flex; gap: 12px;">
                    <button class="add-button" style="background: #10b981;" onclick="exportData()" title="å¯¼å‡ºæ•°æ®">ğŸ“¤ å¯¼å‡º</button>
                    <button class="add-button" style="background: #f59e0b;" onclick="document.getElementById('importFile').click()" title="å¯¼å…¥æ•°æ®">ğŸ“¥ å¯¼å…¥</button>
                    <button class="add-button" onclick="showAddModal()">+ æ–°å»ºå‘½ä»¤</button>
                </div>
            </div>

            <!-- éšè—çš„æ–‡ä»¶è¾“å…¥ -->
            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">

            <div class="commands-container" id="commandsList">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ä½¿ç”¨æŒ‡å—æ¨¡æ€æ¡† -->
    <div class="modal" id="helpModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title">ğŸ“– ä½¿ç”¨æŒ‡å—</h2>
                <button class="close-button" onclick="hideHelpModal()">&times;</button>
            </div>

            <div style="padding: 0 20px 20px; max-height: 60vh; overflow-y: auto;">
                <h3 style="margin-bottom: 16px; color: #111827;">å¿«é€Ÿå¼€å§‹</h3>
                
                <div style="margin-bottom: 24px;">
                    <h4 style="margin-bottom: 8px; color: #374151;">ğŸ¯ æ ¸å¿ƒåŠŸèƒ½</h4>
                    <ul style="color: #6b7280; line-height: 1.6; margin-left: 16px;">
                        <li><strong>æ–°å»ºå‘½ä»¤</strong> - ç‚¹å‡»å³ä¸Šè§’"+ æ–°å»ºå‘½ä»¤"æŒ‰é’®</li>
                        <li><strong>æœç´¢å‘½ä»¤</strong> - ä½¿ç”¨æœç´¢æ¡†æˆ–å¿«æ·é”® Cmd/Ctrl + F</li>
                        <li><strong>å¤åˆ¶å‘½ä»¤</strong> - ç‚¹å‡»å‘½ä»¤å¡ç‰‡ä¸Šçš„"å¤åˆ¶"æŒ‰é’®</li>
                        <li><strong>æ”¶è—å‘½ä»¤</strong> - ç‚¹å‡»â¤ï¸å›¾æ ‡æ·»åŠ åˆ°æ”¶è—</li>
                    </ul>
                </div>

                <div style="margin-bottom: 24px;">
                    <h4 style="margin-bottom: 8px; color: #374151;">âŒ¨ï¸ å¿«æ·é”®</h4>
                    <ul style="color: #6b7280; line-height: 1.6; margin-left: 16px;">
                        <li><strong>Cmd/Ctrl + N</strong> - æ–°å»ºå‘½ä»¤</li>
                        <li><strong>Cmd/Ctrl + F</strong> - èšç„¦æœç´¢æ¡†</li>
                        <li><strong>Esc</strong> - å…³é—­æ¨¡æ€æ¡†</li>
                        <li><strong>Cmd/Ctrl + 1-5</strong> - å¿«é€Ÿåˆ‡æ¢åˆ†ç±»</li>
                    </ul>
                </div>

                <div style="margin-bottom: 24px;">
                    <h4 style="margin-bottom: 8px; color: #374151;">ğŸ“Š åˆ†ç±»ç®¡ç†</h4>
                    <ul style="color: #6b7280; line-height: 1.6; margin-left: 16px;">
                        <li>åœ¨ä¾§è¾¹æ åº•éƒ¨ç‚¹å‡»"æ–°å»ºåˆ†ç±»"</li>
                        <li>ä¸ºåˆ†ç±»é€‰æ‹©é¢œè‰²ä»¥ä¾¿åŒºåˆ†</li>
                        <li>ä½¿ç”¨åˆ†ç±»ç­›é€‰å‘½ä»¤</li>
                    </ul>
                </div>

                <div style="margin-bottom: 24px;">
                    <h4 style="margin-bottom: 8px; color: #374151;">ğŸ“ æ•°æ®ç®¡ç†</h4>
                    <ul style="color: #6b7280; line-height: 1.6; margin-left: 16px;">
                        <li><strong>å¯¼å‡ºæ•°æ®</strong> - å¤‡ä»½æ‰€æœ‰å‘½ä»¤å’Œåˆ†ç±»</li>
                        <li><strong>å¯¼å…¥æ•°æ®</strong> - ä»JSONæ–‡ä»¶æ¢å¤æ•°æ®</li>
                        <li>æ•°æ®è‡ªåŠ¨ä¿å­˜åœ¨æœ¬åœ°æ•°æ®åº“ä¸­</li>
                    </ul>
                </div>

                <div style="background: #f3f4f6; padding: 16px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                    <h4 style="margin-bottom: 8px; color: #111827;">ğŸ’¡ å°è´´å£«</h4>
                    <p style="color: #6b7280; line-height: 1.6; margin: 0;">
                        ä½¿ç”¨æè¿°å’Œæ ‡ç­¾è®©å‘½ä»¤æ›´å®¹æ˜“æ‰¾åˆ°ã€‚å®šæœŸå¯¼å‡ºæ•°æ®ä»¥é˜²æ„å¤–ä¸¢å¤±ã€‚
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ åˆ†ç±»æ¨¡æ€æ¡† -->
    <div class="modal" id="categoryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">æ–°å»ºåˆ†ç±»</h2>
                <button class="close-button" onclick="hideCategoryModal()">&times;</button>
            </div>

            <form id="categoryForm">
                <div class="form-group">
                    <label class="form-label">åˆ†ç±»åç§° *</label>
                    <input type="text" class="form-input" id="categoryName" required>
                </div>

                <div class="form-group">
                    <label class="form-label">åˆ†ç±»æè¿°</label>
                    <textarea class="form-input form-textarea" id="categoryDescription"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">åˆ†ç±»é¢œè‰²</label>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px;">
                        <div class="color-option" data-color="#3b82f6" style="background: #3b82f6;"></div>
                        <div class="color-option" data-color="#ef4444" style="background: #ef4444;"></div>
                        <div class="color-option" data-color="#10b981" style="background: #10b981;"></div>
                        <div class="color-option" data-color="#f59e0b" style="background: #f59e0b;"></div>
                        <div class="color-option" data-color="#8b5cf6" style="background: #8b5cf6;"></div>
                        <div class="color-option" data-color="#ec4899" style="background: #ec4899;"></div>
                        <div class="color-option" data-color="#06b6d4" style="background: #06b6d4;"></div>
                        <div class="color-option" data-color="#84cc16" style="background: #84cc16;"></div>
                    </div>
                    <input type="hidden" id="categoryColor" value="#3b82f6">
                </div>

                <div class="form-actions">
                    <button type="button" class="button secondary" onclick="hideCategoryModal()">å–æ¶ˆ</button>
                    <button type="submit" class="button primary">åˆ›å»ºåˆ†ç±»</button>
                </div>
            </form>
        </div>
    </div>

    <!-- æ·»åŠ /ç¼–è¾‘å‘½ä»¤æ¨¡æ€æ¡† -->
    <div class="modal" id="commandModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">æ–°å»ºå‘½ä»¤</h2>
                <button class="close-button" onclick="hideModal()">&times;</button>
            </div>

            <form id="commandForm">
                <div class="form-group">
                    <label class="form-label">å‘½ä»¤åç§° *</label>
                    <input type="text" class="form-input" id="commandName" required>
                </div>

                <div class="form-group">
                    <label class="form-label">å‘½ä»¤å†…å®¹ *</label>
                    <textarea class="form-input form-textarea" id="commandCode" required></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">æè¿°</label>
                    <textarea class="form-input form-textarea" id="commandDescription"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">åˆ†ç±»</label>
                    <select class="form-input" id="commandCategory">
                        <option value="">é€‰æ‹©åˆ†ç±»</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">æ ‡ç­¾</label>
                    <input type="text" class="form-input" id="commandTags" placeholder="ç”¨é€—å·åˆ†éš”å¤šä¸ªæ ‡ç­¾">
                </div>

                <div class="form-actions">
                    <button type="button" class="button secondary" onclick="hideModal()">å–æ¶ˆ</button>
                    <button type="submit" class="button primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        // å…¨å±€å˜é‡
        let commands = [];
        let categories = [];
        let currentCategory = null;
        let searchTerm = '';
        let editingCommand = null;
        let showFavorites = false;
        let showRecent = false;

        // API åŸºç¡€URL
        const API_BASE = 'http://localhost:9091/api';

        // åˆå§‹åŒ–åº”ç”¨
        async function init() {
            await loadCategories();
            await loadCommands();
        }

        // åŠ è½½åˆ†ç±»
        async function loadCategories() {
            try {
                const response = await fetch(`${API_BASE}/categories`);
                const data = await response.json();
                if (data.success) {
                    categories = data.data;
                    renderCategories();
                    updateCategorySelect();
                }
            } catch (error) {
                showToast('åŠ è½½åˆ†ç±»å¤±è´¥', 'error');
            }
        }

        // åŠ è½½å‘½ä»¤
        async function loadCommands() {
            try {
                let url = `${API_BASE}/commands`;
                const params = new URLSearchParams();

                if (currentCategory) {
                    params.append('category_id', currentCategory);
                }
                if (searchTerm) {
                    params.append('search', searchTerm);
                }
                if (showFavorites) {
                    params.append('favorite', 'true');
                }

                if (params.toString()) {
                    url += '?' + params.toString();
                }

                const response = await fetch(url);
                const data = await response.json();
                if (data.success) {
                    commands = data.data;

                    // å¦‚æœæ˜¯æœ€è¿‘å¸¸ç”¨è¿‡æ»¤ï¼Œä½¿ç”¨æœ¬åœ°è¿‡æ»¤
                    if (showRecent) {
                        commands = getRecentCommands();
                    }

                    renderCommands();
                }
            } catch (error) {
                showToast('åŠ è½½å‘½ä»¤å¤±è´¥', 'error');
            }
        }

        // æ¸²æŸ“åˆ†ç±»åˆ—è¡¨
        function renderCategories() {
            const container = document.getElementById('categoriesList');

            let html = `
                <div class="category-item ${!currentCategory && !showFavorites && !showRecent ? 'active' : ''}" onclick="selectCategory(null)">
                    <div class="category-color" style="background: #6b7280;"></div>
                    <span>å…¨éƒ¨å‘½ä»¤</span>
                    <span class="category-count">${commands.length}</span>
                </div>
                <div class="category-item ${showRecent ? 'active' : ''}" onclick="toggleRecentFilter()">
                    <div class="category-color" style="background: #3b82f6;">ğŸ•’</div>
                    <span>æœ€è¿‘å¸¸ç”¨</span>
                    <span class="category-count">${getRecentCommands().length}</span>
                </div>
                <div class="category-item ${showFavorites ? 'active' : ''}" onclick="toggleFavoriteFilter()">
                    <div class="category-color" style="background: #ef4444;">â¤ï¸</div>
                    <span>æ”¶è—çš„å‘½ä»¤</span>
                    <span class="category-count">${commands.filter(cmd => cmd.is_favorite).length}</span>
                </div>
            `;

            categories.forEach(category => {
                html += `
                    <div class="category-item ${currentCategory === category.id ? 'active' : ''}" onclick="selectCategory(${category.id})">
                        <div class="category-color" style="background: ${category.color};"></div>
                        <span>${category.name}</span>
                        <span class="category-count">${category.command_count}</span>
                    </div>
                `;
            });

            // æ·»åŠ åˆ›å»ºåˆ†ç±»æŒ‰é’®
            html += `
                <div class="category-item" onclick="showAddCategoryModal()" style="border: 1px dashed #d1d5db; margin-top: 8px;">
                    <div class="category-color" style="background: #f3f4f6; display: flex; align-items: center; justify-content: center; color: #9ca3af;">+</div>
                    <span style="color: #6b7280;">æ–°å»ºåˆ†ç±»</span>
                </div>
            `;

            container.innerHTML = html;
        }

        // æ¸²æŸ“å‘½ä»¤åˆ—è¡¨
        function renderCommands() {
            const container = document.getElementById('commandsList');

            if (commands.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“</div>
                        <h3>è¿˜æ²¡æœ‰å‘½ä»¤</h3>
                        <p>ç‚¹å‡»"æ–°å»ºå‘½ä»¤"æŒ‰é’®åˆ›å»ºæ‚¨çš„ç¬¬ä¸€ä¸ªå‘½ä»¤</p>
                    </div>
                `;
                return;
            }

            let html = '';
            commands.forEach(command => {
                html += `
                    <div class="command-card">
                        <div class="command-header">
                            <div>
                                <div class="command-name">${command.name}</div>
                                ${command.category_name ? `
                                    <div class="command-category">
                                        <div class="category-color" style="background: ${command.category_color};"></div>
                                        ${command.category_name}
                                    </div>
                                ` : ''}
                            </div>
                            <div class="command-actions">
                                <button class="action-button ${command.is_favorite ? 'favorite' : ''}" onclick="toggleFavorite(${command.id})" title="${command.is_favorite ? 'å–æ¶ˆæ”¶è—' : 'æ·»åŠ æ”¶è—'}">
                                    ${command.is_favorite ? 'â¤ï¸' : 'ğŸ¤'}
                                </button>
                                <button class="action-button primary" onclick="copyCommand('${command.command.replace(/'/g, "\\'")}', ${command.id})">å¤åˆ¶</button>
                                <button class="action-button" onclick="editCommand(${command.id})">ç¼–è¾‘</button>
                                <button class="action-button" onclick="deleteCommand(${command.id})">åˆ é™¤</button>
                            </div>
                        </div>

                        <div class="command-code">${command.command}</div>

                        ${command.description ? `<div class="command-description">${command.description}</div>` : ''}

                        <div class="command-meta">
                            <span>ä½¿ç”¨ ${command.usage_count} æ¬¡</span>
                            <span>æœ€åä½¿ç”¨: ${command.last_used ? new Date(command.last_used).toLocaleString() : 'ä»æœªä½¿ç”¨'}</span>
                            <span>åˆ›å»ºäº: ${new Date(command.created_at).toLocaleDateString()}</span>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
            updateStats();
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            const totalCommands = commands.length;
            const favoriteCommands = commands.filter(cmd => cmd.is_favorite).length;
            const today = new Date().toDateString();
            const todayUsage = commands.reduce((total, cmd) => {
                const lastUsed = cmd.last_used ? new Date(cmd.last_used).toDateString() : null;
                return total + (lastUsed === today ? 1 : 0);
            }, 0);

            document.getElementById('totalCommands').textContent = totalCommands;
            document.getElementById('favoriteCommands').textContent = favoriteCommands;
            document.getElementById('todayUsage').textContent = todayUsage;
        }

        // æ›´æ–°åˆ†ç±»é€‰æ‹©æ¡†
        function updateCategorySelect() {
            const select = document.getElementById('commandCategory');
            let html = '<option value="">é€‰æ‹©åˆ†ç±»</option>';

            categories.forEach(category => {
                html += `<option value="${category.id}">${category.name}</option>`;
            });

            select.innerHTML = html;
        }

        // é€‰æ‹©åˆ†ç±»
        function selectCategory(categoryId) {
            currentCategory = categoryId;
            showFavorites = false;
            showRecent = false;
            loadCommands();
            renderCategories();
        }

        // åˆ‡æ¢æ”¶è—è¿‡æ»¤
        function toggleFavoriteFilter() {
            showFavorites = !showFavorites;
            showRecent = false;
            currentCategory = null;
            loadCommands();
            renderCategories();
        }

        // åˆ‡æ¢æœ€è¿‘å¸¸ç”¨è¿‡æ»¤
        function toggleRecentFilter() {
            showRecent = !showRecent;
            showFavorites = false;
            currentCategory = null;
            loadCommands();
            renderCategories();
        }

        // è·å–æœ€è¿‘å¸¸ç”¨å‘½ä»¤ï¼ˆæŒ‰ä½¿ç”¨æ¬¡æ•°å’Œæœ€åä½¿ç”¨æ—¶é—´æ’åºï¼‰
        function getRecentCommands() {
            const now = new Date();
            const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);

            return commands
                .filter(cmd => cmd.usage_count > 0) // è‡³å°‘ä½¿ç”¨è¿‡ä¸€æ¬¡
                .sort((a, b) => {
                    // ä¼˜å…ˆæŒ‰ä½¿ç”¨æ¬¡æ•°æ’åºï¼Œç„¶åæŒ‰æœ€åä½¿ç”¨æ—¶é—´
                    if (b.usage_count !== a.usage_count) {
                        return b.usage_count - a.usage_count;
                    }
                    const aTime = a.last_used ? new Date(a.last_used) : new Date(a.updated_at);
                    const bTime = b.last_used ? new Date(b.last_used) : new Date(b.updated_at);
                    return bTime - aTime;
                })
                .slice(0, 10); // åªæ˜¾ç¤ºå‰10ä¸ª
        }

        // åˆ‡æ¢æ”¶è—çŠ¶æ€
        async function toggleFavorite(commandId) {
            try {
                const command = commands.find(c => c.id === commandId);
                if (!command) return;

                const response = await fetch(`${API_BASE}/commands/${commandId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_favorite: !command.is_favorite })
                });

                const data = await response.json();

                if (data.success) {
                    showToast(command.is_favorite ? 'å·²å–æ¶ˆæ”¶è—' : 'å·²æ·»åŠ åˆ°æ”¶è—', 'success');
                    loadCommands();
                    loadCategories();
                } else {
                    showToast('æ“ä½œå¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('æ“ä½œå¤±è´¥', 'error');
            }
        }

        // æœç´¢å‘½ä»¤
        function searchCommands() {
            searchTerm = document.getElementById('searchInput').value;
            loadCommands();
        }

        // å¤åˆ¶å‘½ä»¤
        async function copyCommand(command, commandId) {
            try {
                await navigator.clipboard.writeText(command);
                showToast('å‘½ä»¤å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');

                // å¢åŠ ä½¿ç”¨æ¬¡æ•°
                await fetch(`${API_BASE}/commands/${commandId}/use`, { method: 'POST' });
                loadCommands();
            } catch (error) {
                showToast('å¤åˆ¶å¤±è´¥', 'error');
            }
        }

        // æ˜¾ç¤ºæ·»åŠ åˆ†ç±»æ¨¡æ€æ¡†
        function showAddCategoryModal() {
            document.getElementById('categoryForm').reset();
            document.getElementById('categoryColor').value = '#3b82f6';
            // é‡ç½®é¢œè‰²é€‰æ‹©
            document.querySelectorAll('.color-option').forEach(option => {
                option.classList.remove('selected');
            });
            document.querySelector('.color-option[data-color="#3b82f6"]').classList.add('selected');
            document.getElementById('categoryModal').classList.add('show');
        }

        // éšè—åˆ†ç±»æ¨¡æ€æ¡†
        function hideCategoryModal() {
            document.getElementById('categoryModal').classList.remove('show');
        }

        // æ˜¾ç¤ºå¸®åŠ©æ¨¡æ€æ¡†
        function showHelpModal() {
            document.getElementById('helpModal').classList.add('show');
        }

        // éšè—å¸®åŠ©æ¨¡æ€æ¡†
        function hideHelpModal() {
            document.getElementById('helpModal').classList.remove('show');
        }

        // æ˜¾ç¤ºæ·»åŠ æ¨¡æ€æ¡†
        function showAddModal() {
            editingCommand = null;
            document.getElementById('modalTitle').textContent = 'æ–°å»ºå‘½ä»¤';
            document.getElementById('commandForm').reset();
            document.getElementById('commandModal').classList.add('show');
        }

        // ç¼–è¾‘å‘½ä»¤
        function editCommand(commandId) {
            const command = commands.find(c => c.id === commandId);
            if (!command) return;

            editingCommand = command;
            document.getElementById('modalTitle').textContent = 'ç¼–è¾‘å‘½ä»¤';
            document.getElementById('commandName').value = command.name;
            document.getElementById('commandCode').value = command.command;
            document.getElementById('commandDescription').value = command.description || '';
            document.getElementById('commandCategory').value = command.category_id || '';
            document.getElementById('commandTags').value = command.tags || '';
            document.getElementById('commandModal').classList.add('show');
        }

        // åˆ é™¤å‘½ä»¤
        async function deleteCommand(commandId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå‘½ä»¤å—ï¼Ÿ')) return;

            try {
                const response = await fetch(`${API_BASE}/commands/${commandId}`, {
                    method: 'DELETE'
                });
                const data = await response.json();

                if (data.success) {
                    showToast('å‘½ä»¤åˆ é™¤æˆåŠŸ', 'success');
                    loadCommands();
                    loadCategories();
                } else {
                    showToast('åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('åˆ é™¤å¤±è´¥', 'error');
            }
        }

        // éšè—æ¨¡æ€æ¡†
        function hideModal() {
            document.getElementById('commandModal').classList.remove('show');
        }

        // ä¿å­˜å‘½ä»¤
        async function saveCommand(event) {
            event.preventDefault();

            const formData = {
                name: document.getElementById('commandName').value,
                command: document.getElementById('commandCode').value,
                description: document.getElementById('commandDescription').value,
                category_id: document.getElementById('commandCategory').value || null,
                tags: document.getElementById('commandTags').value
            };

            try {
                let response;
                if (editingCommand) {
                    response = await fetch(`${API_BASE}/commands/${editingCommand.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });
                } else {
                    response = await fetch(`${API_BASE}/commands`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });
                }

                const data = await response.json();

                if (data.success) {
                    showToast(editingCommand ? 'å‘½ä»¤æ›´æ–°æˆåŠŸ' : 'å‘½ä»¤åˆ›å»ºæˆåŠŸ', 'success');
                    hideModal();
                    loadCommands();
                    loadCategories();
                } else {
                    showToast('ä¿å­˜å¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('ä¿å­˜å¤±è´¥', 'error');
            }
        }

        // å¯¼å‡ºæ•°æ®
        async function exportData() {
            try {
                const [commandsData, categoriesData] = await Promise.all([
                    fetch(`${API_BASE}/commands`).then(r => r.json()),
                    fetch(`${API_BASE}/categories`).then(r => r.json())
                ]);

                const exportData = {
                    commands: commandsData.data || [],
                    categories: categoriesData.data || [],
                    exportDate: new Date().toISOString(),
                    version: '1.0.0'
                };

                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `commands-backup-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showToast('æ•°æ®å¯¼å‡ºæˆåŠŸ', 'success');
            } catch (error) {
                showToast('å¯¼å‡ºå¤±è´¥', 'error');
            }
        }

        // å¯¼å…¥æ•°æ®
        async function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const text = await file.text();
                const data = JSON.parse(text);

                if (!data.commands || !data.categories) {
                    showToast('æ— æ•ˆçš„æ•°æ®æ ¼å¼', 'error');
                    return;
                }

                let importedCommands = 0;
                let importedCategories = 0;

                // å¯¼å…¥åˆ†ç±»
                for (const category of data.categories) {
                    try {
                        await fetch(`${API_BASE}/categories`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                name: category.name,
                                description: category.description,
                                color: category.color
                            })
                        });
                        importedCategories++;
                    } catch (error) {
                        console.warn('å¯¼å…¥åˆ†ç±»å¤±è´¥:', category.name);
                    }
                }

                // å¯¼å…¥å‘½ä»¤
                for (const command of data.commands) {
                    try {
                        await fetch(`${API_BASE}/commands`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                name: command.name,
                                command: command.command,
                                description: command.description,
                                category_id: command.category_id,
                                tags: command.tags,
                                is_favorite: command.is_favorite || false
                            })
                        });
                        importedCommands++;
                    } catch (error) {
                        console.warn('å¯¼å…¥å‘½ä»¤å¤±è´¥:', command.name);
                    }
                }

                showToast(`å¯¼å…¥æˆåŠŸï¼š${importedCommands} ä¸ªå‘½ä»¤ï¼Œ${importedCategories} ä¸ªåˆ†ç±»`, 'success');
                loadCommands();
                loadCategories();
            } catch (error) {
                showToast('å¯¼å…¥å¤±è´¥ï¼š' + error.message, 'error');
            }

            // é‡ç½®æ–‡ä»¶è¾“å…¥
            event.target.value = '';
        }

        // æ˜¾ç¤ºæç¤º
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type} show`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }

        // å¿«æ·é”®æ”¯æŒ
        document.addEventListener('keydown', function(event) {
            // Cmd/Ctrl + N: æ–°å»ºå‘½ä»¤
            if ((event.metaKey || event.ctrlKey) && event.key === 'n') {
                event.preventDefault();
                showAddModal();
            }

            // Cmd/Ctrl + F: èšç„¦æœç´¢æ¡†
            if ((event.metaKey || event.ctrlKey) && event.key === 'f') {
                event.preventDefault();
                document.getElementById('searchInput').focus();
            }

            // Escape: å…³é—­æ¨¡æ€æ¡†
            if (event.key === 'Escape') {
                hideModal();
            }

            // Cmd/Ctrl + 1-5: å¿«é€Ÿåˆ‡æ¢åˆ†ç±»
            if ((event.metaKey || event.ctrlKey) && event.key >= '1' && event.key <= '5') {
                event.preventDefault();
                const categoryIndex = parseInt(event.key) - 1;
                if (categoryIndex === 0) {
                    selectCategory(null);
                } else if (categories[categoryIndex - 1]) {
                    selectCategory(categories[categoryIndex - 1].id);
                }
            }
        });

        // ä¿å­˜åˆ†ç±»
        async function saveCategory(event) {
            event.preventDefault();

            const formData = {
                name: document.getElementById('categoryName').value,
                description: document.getElementById('categoryDescription').value,
                color: document.getElementById('categoryColor').value
            };

            try {
                const response = await fetch(`${API_BASE}/categories`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (data.success) {
                    showToast('åˆ†ç±»åˆ›å»ºæˆåŠŸ', 'success');
                    hideCategoryModal();
                    loadCategories();
                } else {
                    showToast('åˆ›å»ºå¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                showToast('åˆ›å»ºå¤±è´¥', 'error');
            }
        }

        // äº‹ä»¶ç›‘å¬
        document.getElementById('searchInput').addEventListener('input', searchCommands);
        document.getElementById('commandForm').addEventListener('submit', saveCommand);
        document.getElementById('categoryForm').addEventListener('submit', saveCategory);

        // é¢œè‰²é€‰æ‹©å™¨äº‹ä»¶
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('color-option')) {
                // ç§»é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
                document.querySelectorAll('.color-option').forEach(option => {
                    option.classList.remove('selected');
                });
                // æ·»åŠ é€‰ä¸­çŠ¶æ€
                event.target.classList.add('selected');
                // è®¾ç½®é¢œè‰²å€¼
                document.getElementById('categoryColor').value = event.target.dataset.color;
            }
        });

        // åˆå§‹åŒ–åº”ç”¨
        init();
    </script>
</body>
</html>
